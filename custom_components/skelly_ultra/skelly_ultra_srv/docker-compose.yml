services:
  skelly-ultra-server:
    build: .
    container_name: skelly-ultra-server
    restart: unless-stopped
    network_mode: host
    privileged: true

    volumes:
      # Mount D-Bus socket for Bluetooth pairing
      - /var/run/dbus:/var/run/dbus
      - /run/dbus:/run/dbus
      # Mount PipeWire runtime directory for audio playback
      # Note: Replace '1000' with your actual user ID (run 'id -u' to find it)
      - /run/user/1000/pipewire-0:/run/user/0/pipewire-0
      # Optional: Persist audio files
      - ./audio_cache:/tmp/skelly_audio

    environment:
      # Server configuration
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=8765
      # PipeWire runtime directory
      - XDG_RUNTIME_DIR=/run/user/0
      # Logging
      - PYTHONUNBUFFERED=1

    # Health check
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8765/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Notes:
# - This container requires privileged mode and host network to access Bluetooth hardware
# - The host must have a working Bluetooth adapter
# - D-Bus system bus must be accessible for automated pairing
#
# To run:
#   docker-compose up -d
#
# To view logs:
#   docker-compose logs -f
#
# To stop:
#   docker-compose down
